<!DOCTYPE HTML>
<html>
<head>
<title>Release tool</title>
<script type="text/javascript" src="lib/zip.js/WebContent/zip.js"></script>
<script>zip.useWebWorkers = false;</script>
<script type="text/javascript" src="lib/zip.js/WebContent/inflate.js"></script>
<script type="text/javascript" src="lib/zip.js/WebContent/deflate.js"></script>
<script type="text/javascript" src="lib/SparkMD5/spark-md5.js"></script>
</head>

<body>
<header>Internal tool to simplify release hidden JSON creation</header>
<p><label><span class="form-label">choose a zip file</span><input type="file" accept="application/zip" id="file-input"></label></p>
<p><span class="form-label">zip hashes</span>
<dl id="file-list"></dl>
</p>

<script>
//Adapted from https://raw.githubusercontent.com/gildas-lormeau/zip.js/gh-pages/demos/demo2.js
(function(obj) {

	function onerror(message) {
		alert(message);
		console.log(message);
	}

	var model = (function() {
		return {
			getEntries : function(file, onend) {
				zip.createReader(new zip.BlobReader(file), function(zipReader) {
					zipReader.getEntries(onend);
				}, onerror);
			},
			getEntryBlob : function(entry, onend, onprogress) {
				var writer = new zip.BlobWriter();
				
				entry.getData(writer, function(blob) {
					onend(blob);
				}, onprogress);
			}
		};
	})();

	(function() {
		var fileInput = document.getElementById("file-input");
		var fileList = document.getElementById("file-list");
		
		var hashes = [];
		
		function addHash(entry, dd, callback) {
			var unzipProgress = document.createElement("progress");
			
			model.getEntryBlob(entry, function(blobURL) {
				unzipProgress.value = 0;
				unzipProgress.max = 0;
				
				fileReader = new FileReader();
				
				fileReader.onerror = function () {
					console.warn('oops, something went wrong.');
				};
				
				fileReader.onloadend = function (e) {
					if (fileReader.result == null) {
						return;
					}
					
					var hash = SparkMD5.ArrayBuffer.hash(fileReader.result, false);
					dd.textContent = hash;
					
					if (entry.filename.indexOf("wdl") === 0 && entry.filename.indexOf(".") !== -1) {
						// Only include files starting with WDL
						// and that have a file extension.
					
						var hashInfo = {};
						
						var path = entry.filename;
						var innerClassIndex = path.indexOf("$");
						var relativeTo;
						if (innerClassIndex !== -1) {
							// Start to first $
							relativeTo = path.substring(0, innerClassIndex);
						} else {
							// Full path minus trailing .class
							relativeTo = path.substring(0, path.lastIndexOf("."));
						}
						relativeTo = relativeTo.replace(/\//g, ".");
						
						// End of the package name.
						var classNameStart = relativeTo.lastIndexOf(".") + 1;
						
						// File name relative to the given class.
						var fileName = path.substring(classNameStart);
						
						hashInfo["RelativeTo"] = relativeTo;
						hashInfo["File"] = fileName;
						
						// TODO: Right now, we only have 1 possible hash; it may be wanted to have more
						// than one in the future.
						var possibleHashes = [];
						possibleHashes.push(hash);
						hashInfo["Hash"] = possibleHashes;
						
						hashes.push(hashInfo);
					}
					
					callback();
				}
				
				fileReader.readAsArrayBuffer(blobURL);
			}, function(current, total) {
				unzipProgress.value = current;
				unzipProgress.max = total;
				dd.appendChild(unzipProgress);
			});
		}
		
		fileInput.addEventListener('change', function() {
			fileInput.disabled = true;
			model.getEntries(fileInput.files[0], function(entries) {
				fileList.innerHTML = "";
				
				var currentEntryNum = 0;
				
				var data = {};
				
				var nextEntry = function() {
					if (currentEntryNum >= entries.length) {
						data["Hashes"] = hashes;
						
						var jsonStr = JSON.stringify(data);
						
						console.log(jsonStr);
						console.log(JSON.stringify(data, null, ' '))
						
						return;
					}
					
					var entry = entries[currentEntryNum];
					currentEntryNum++;
					
					var dt = document.createElement("dt");
					dt.textContent = entry.filename;
					var dd = document.createElement("dd");
					
					fileList.appendChild(dt);
					fileList.appendChild(dd);
					
					dd.textContent = "";
					
					addHash(entry, dd, nextEntry);
				}
				
				nextEntry();
			});
		}, false);
	})();

})(this);
</script>

</body>
</html>
